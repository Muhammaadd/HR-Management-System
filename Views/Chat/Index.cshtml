@model List<UsersChatViewModel>
@{
Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>MEGZ</title>
<base href="/" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
rel="stylesheet"
/>
    <link rel="apple-touch-icon" sizes="120x120" href="~/app-assets/img/ico/apple-icon-120.html">
<link
rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css"
integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A=="
crossorigin="anonymous"
referrerpolicy="no-referrer"
/>
<link
href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
rel="stylesheet"
integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
crossorigin="anonymous"
/>
<link rel="stylesheet" type="text/css" href="~/app-assets/css/chat.css">
</head>
<body>
<!-- nav bar  -->
<div
class="col-12 offset-xl-2 col-xl-10 px-4 py-3 justify-content-between d-flex align-items-center"
>
<div class="leftsection">
<i class="me-4 d-inline d-xl-none fa-solid fa-bars"></i>
<a><i class="me-4 fa fa-qrcode"></i></a>
<a><i class="me-4 fas fa-chart-line"></i></a>
<a><i class="me-4 far fa-edit"></i></a>
<a><span>Apps</span></a>
<a><i class="ms-1 fa-solid fa-caret-down"></i></a>
</div>
<div class="rightsection">
<a><i class="ms-4 fas fa-globe"></i></a>
<a><i class="ms-4 far fa-comment"></i></a>
<a><i class="ms-4 far fa-bell"></i></a>
<a>
<img class="ms-5 profilPic" src="~/images/ChatImages/avatar-s-15.jpg" alt="" />
<i class="ms-1 fa-solid fa-caret-down"></i>
</a>
</div>
</div>
<!-- end nav bar -->
<!-- aside -->
<div class="aside col-2 d-none d-xl-block">
<div
class="header px-2 py-3 d-flex justify-content-between align-items-center"
>
<img class="logo" src="~/images/ChatImages/logo.png" alt="" />
<p class="systemName fw-bold fs-3 text-light text-uppercase">
Hr system
</p>
</div>
<div class="list px-1 py-3">
<a asp-action="Index" asp-controller="Home" class="item p-2 ps-3 align-items-center d-flex mb-3">
<i class="fa-solid fa-house"></i>
<p class="ms-3">Dashboard</p>
</a>
<a asp-action="Index" asp-controller="Employee"
class="item p-2 ps-3 align-items-center d-flex mb-3"
>
<i class="fa-solid fa-users"></i>
<p class="ms-3">Employee</p>
</a>
<a asp-action="Add" asp-controller="Employee"
class="item p-2 ps-3 align-items-center d-flex mb-3"
>
<i class="fa-solid fa-pen-to-square"></i>
<p class="ms-3">Add Employee</p>
</a>
<a asp-action="Index" asp-controller="GeneralSetting" class="item p-2 ps-3 align-items-center d-flex mb-3">
<i class="fa fa-gear"></i>
<p class="ms-3">General Settings</p>
</a>
<a asp-action="Index" asp-controller="Attendance" class="item p-2 ps-3 align-items-center d-flex mb-3">
<i class="fa-solid fa-clipboard-user"></i>
<p class="ms-3">Attendence</p>
</a>
<a asp-action="Index" asp-controller="Salary" class="item p-2 ps-3 align-items-center d-flex mb-3">
<i class="fas fa-file-signature"></i>
<p class="ms-3">Salary report</p>
</a>
<a asp-action="Index" asp-controller="User" class="item p-2 ps-3 align-items-center d-flex mb-3">
<i class="fa-solid fa-user-group"></i>
<p class="ms-3">Users</p>
</a>
<a asp-action="Index" asp-controller="Group" class="item p-2 ps-3 align-items-center d-flex mb-3">
<i class="fa fa-gear"></i>
<p class="ms-3">Permissions</p>
</a>
<a asp-action="Index" asp-controller="Chat" class="item p-2 ps-3 align-items-center d-flex mb-3">
<i class="far fa-comments"></i>
<p class="ms-3">Chat</p>
</a>
</div>
</div>
<!-- End aside -->
<div style="background-color: #ddd; padding: 5px 20px 20px 20px">
<div class="mt-5 container offset-2 col-10">
<div class="row">
<div class="col-md-12">
<div class="chatroom d-flex">
<div class="left-side col-4" style="background-color: white">
<div class="search mb-3 px-3">
<div class="input-group mb-3">
<input type="text" class="form-control p-0" placeholder="Search"  aria-label="Example text with button addon" aria-describedby="button-addon1" />
</div>
</div>
<div class="members-container p-3">
@foreach (UsersChatViewModel User in Model)
{
<div onclick="setFriendName(event)" class="member p-3 border-bottom mb-4">
    <div class="content d-flex align-items-center">
        <img src="~/images/ChatImages/avatar-s-15.jpg" alt="" />
        <p>@User.Name</p>
        <input type="hidden" asp-for="@User.Id" />
        <input type="hidden" asp-for="@User.UserName" />
    </div>
</div>        
}
</div>
</div>
<div class="right-side position-relative col-8">
<div class="chatheader p-3" style="background-color: white">
<div
class="d-flex align-items-center justify-content-between"
>
<div class="content custom d-flex align-items-center">
<img src="~/images/ChatImages/avatar-s-15.jpg" alt="" />
<div>
<p id="friendName"></p>
<p id="online" style="color: #3ed73e">Online</p>
@*<p id="offline" class="text-danger">Offline</p>*@
</div>
</div>
<i class="fas fa-ellipsis-v fs-4"></i>
</div>
</div>
<div id="messagesContainer" class="messages-container position-relative px-4">
<div class="d-flex justify-content-center">
<p
class="fixed chat-history py-1 px-3 rounded text-white bg-black fw-bold"
>
Chat History
</p>
</div>
</div>
<form data-ajax="true" asp-action="SaveMessagesInDatabase" method="post">
<input id="userId" name="receiveId" type="hidden" />
<input id="currentId" value="@ViewBag.Id" name="senderId" type="hidden" />
<input id="messageTosend" name="message" type="hidden" />
<div style="margin: 0" class="input-group message-con position-absolute">
<input  class="form-control m-0" id="messageInput" placeholder="Enter your message..." aria-label="Recipient's username" aria-describedby="button-addon2"/>
<button  onclick="sendMessage()" class="btn btn-success" type="submit" id="btn">Send</button>
</div>
</form>
</div>
</div>
</div>
</div>
</div>
</div>

<script src="~/lib/jquery/dist/jquery.js"></script>  
<script src="~/jquery-ajax-unobtrusive/jquery.unobtrusive-ajax.js"></script> 
<script src="~/images/ChatImages/https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
<script src="~/lib/microsoft-signalr/signalr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
var currentId = document.getElementById("currentId");
var messagesContainer = document.getElementById("messagesContainer");
var memberName = document.querySelector(".member");
var friendName = document.getElementById("friendName");
var userId = document.getElementById("userId");


    var hubConnection = new signalR.HubConnectionBuilder().withUrl("/OnlineChat").build();
        hubConnection.start().then(function() {
            console.log("Connection Successful")
        }).catch(function(){
            console.log("Error to connect on the hub")
        });
    hubConnection.on("RecieveMessage", function(Message) { 
        CreateReceivedMessagesStructure(Message)
        messagesContainer.scroll({ top: messagesContainer.scrollHeight, behavior: "smooth"})
    });
    
    function sendMessage(){
        var message = document.getElementById("messageInput")
        var messageTosend = document.getElementById("messageTosend");
        if(message.value === '')
            return
        hubConnection.invoke("SendMessage",userId.value, message.value)
        CreateSendedMessagesStructure(message.value)
        messageTosend.value = message.value;
        message.value = ''
        messagesContainer.scroll({ top: messagesContainer.scrollHeight, behavior: "smooth"})
    }
    function setFriendName(){
        messagesContainer.innerHTML =''
        friendName.innerHTML = event.target.children[0].children[1].innerHTML
        userId.value = event.target.children[0].children[2].value
        var members = document.querySelectorAll(".member")
        for (var i = 0; i < members.length;i++)
        {
            members[i].children[0].children[1].style.color = 'black'
        }
        event.target.children[0].children[1].style.color = 'blue'
        $.ajax({url: `http://localhost:48267/Chat/GetMessages?currentId=${currentId.value}&otherId=${userId.value}`, success: function(result){
        console.log("currentid",currentId.value)
        console.log("otherid",userId.value)
        console.log(result)
        for(var record of result)
       {
            if (record.currentUserId===currentId.value) 
                CreateSendedMessagesStructure(record.message)
            if(record.currentUserId===userId.value)
                CreateReceivedMessagesStructure(record.message)
            messagesContainer.scroll({ top: messagesContainer.scrollHeight, behavior: "smooth"})
            console.log("My id",record.currentUserId)
            console.log("other id",record.otherUserId)
            console.log("Message", record.message)
            console.log("-------------------------")
       }
       }});
    }
    function setFriendNameAutomaticlly(){
       friendName.innerHTML = memberName.children[0].children[1].innerHTML
       memberName.children[0].children[1].style.color = 'blue'
       userId.value = memberName.children[0].children[2].value
       $.ajax({url: `http://localhost:48267/Chat/GetMessages?currentId=${currentId.value}&otherId=${userId.value}`, success: function(result){
       for(var record of result)
       {
            if (record.currentUserId===currentId.value) 
                CreateSendedMessagesStructure(record.message)
            if(record.currentUserId===userId.value)
                CreateReceivedMessagesStructure(record.message)
            messagesContainer.scroll({ top: messagesContainer.scrollHeight, behavior: "smooth"})
            console.log("My id",record.currentUserId)
            console.log("other id",record.otherUserId)
            console.log("Message", record.message)
            console.log("-------------------------")
       }
       }});
    }
    setFriendNameAutomaticlly()
    
function CreateReceivedMessagesStructure(RecievedMessage) {
    var messageContainer = document.createElement("div");
    messageContainer.className = "message d-flex align-items-center justify-content-start";
    var profileImg = document.createElement("img");
    profileImg.className = "me-4";
    profileImg.src = "/images/ChatImages/avatar-s-15.jpg";
    var leftArrow = document.createElement("i");
    leftArrow.className = "text-secondary fa-solid right-arrow fa-caret-left";
    var message = document.createElement("p");
    message.className = "message-shape ms-3 bg-secondary text-white p-2";
    message.innerText = RecievedMessage;
    messageContainer.appendChild(profileImg);
    messageContainer.appendChild(leftArrow);
    messageContainer.appendChild(message);
    messagesContainer.appendChild(messageContainer);
}
    function CreateSendedMessagesStructure(sendedMessage){ 
        var messageContainer = document.createElement("div")
        messageContainer.className ="message d-flex align-items-center justify-content-end"
        var message = document.createElement("p")
        message.className ="message-shape me-3 bg-primary text-white p-2"
        message.innerText = sendedMessage
        var rightArrow = document.createElement("i")
        rightArrow.className ="text-primary fa-solid right-arrow fa-caret-right"
        var profileImg = document.createElement("img")
        profileImg.className ="ms-2"
        profileImg.src = "/images/ChatImages/avatar-s-15.jpg"
        messageContainer.appendChild(message)
        messageContainer.appendChild(rightArrow)
        messageContainer.appendChild(profileImg)
        messagesContainer.appendChild(messageContainer)
}


</script>

</body>
</html>
